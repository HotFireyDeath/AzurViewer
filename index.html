<!DOCTYPE html>

<!-- 
AzurViewer
[ A web explorer for Azur Lane. Look at detailed ship stats, descriptions and more. ]
-------
What is the license?
Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0), as stated with Wikimedia-related content unless stated otherwise.
See link for more details: https://creativecommons.org/licenses/by-nc-sa/4.0/
How does it work?
Essentially, the app scrapes data from the wiki and parses it correctly into an app. This removes the need to rewrite tons and tons of 
existing information. (phew). Of course, too many requests will flood the wiki, so data is attempted caching into localStorage.
Developed by Chen Zheng (@HotFireyDeath)
-->

<html>
<head>
    <title>AzurViewer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"
          integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

    <!-- JQUERY -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <!-- MATERIALIZE -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>


    <style> body {
        font-family: "Open Sans", serif;
    } </style>
</head>
<body>

<nav id="omnisearch" style="display: none;">
    <div class="nav-wrapper blue darken-1">
        <form>
            <div class="input-field">
                <input id="search" type="search" placeholder="Type 'help' for navigation options">
                <label class="label-icon" for="search"><i class="fas fa-search"></i></label>
                <i class="material-icons fas fa-times" onclick="$('#search').val('');"></i>
            </div>
        </form>
    </div>
</nav>

<div class="container">
    <ul class="collection" id="search_results" style="display: none;"></ul>
</div>

<div id="loading_pleaseWait">
    <div class="container">
        <div class="card horizontal">
            <div class="card-image">
                <img id="loading_pleaseWait_char" src="https://azurlane.koumakan.jp/w/images/f/fb/SaratogaChibi.png">
            </div>
            <div class="card-stacked">
                <div class="card-content" style="text-align: center;" id="loading_pleaseWait_phrase">
                    <span class="card-title">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="ship_displayCase" style="display: none;">
    <div class="container">
        <h4 id="ship_displayCase_name" style="text-align: center;"></h4>
        <p id="rawDATA"></p> <!-- remove after development -->
    </div>
</div>

<script>

    // Set random loading character and 'slogan'.
    var loadingRandoms = {
        "https://azurlane.koumakan.jp/w/images/8/86/LaffeyChibi.png": "Commander... wait here (yawn)...",
        "https://azurlane.koumakan.jp/w/images/f/fb/SaratogaChibi.png": "Commander, please wait a moment~",
        "https://azurlane.koumakan.jp/w/images/0/08/AyanamiChibi.png": "Please wait a second, commander...",
        "https://azurlane.koumakan.jp/w/images/8/84/BelfastChibi.png": "Pardon me, Commander, but you will have to wait a second. In the meantime, would you like some tea?",
        "https://azurlane.koumakan.jp/w/images/7/70/AkashiChibi.png": "Commander, wait here while I examine the site meow...",
        "https://azurlane.koumakan.jp/w/images/e/e7/UnicornChibi.png": "Big brother... Unicorn will stay with you while you wait...",
        "https://azurlane.koumakan.jp/w/images/2/2c/Ning_HaiChibi.png": "I wonder if the fleet's expenses can be covered by this site..."
    };
    // This is a slightly modified version of the solution found here: https://stackoverflow.com/a/15106541
    var randomKey = function (loadingRandoms) {
        var keys = Object.keys(loadingRandoms);
        return keys[keys.length * Math.random() << 0];
    };
    randomKey = randomKey(loadingRandoms);
    $("#loading_pleaseWait_char").attr("src", randomKey);
    var phrase = $("#loading_pleaseWait_phrase");
    phrase.html(phrase.html() + loadingRandoms[randomKey]);


    // An object containing the URL to useful icons.
    var icons = {
        "firepower": "https://azurlane.koumakan.jp/w/images/thumb/d/d5/Firepower.png/25px-Firepower.png",
        "health": "https://azurlane.koumakan.jp/w/images/thumb/8/8b/Duration.png/25px-Duration.png",
        "anti_air": "https://azurlane.koumakan.jp/w/images/thumb/0/0f/AntiAir.png/25px-AntiAir.png",
        "evasion": "https://azurlane.koumakan.jp/w/images/thumb/d/d2/Evasion.png/25px-Evasion.png",
        "air_power": "https://azurlane.koumakan.jp/w/images/thumb/6/6a/Aviation.png/25px-Aviation.png",
        "aviation": "https://azurlane.koumakan.jp/w/images/thumb/6/6a/Aviation.png/25px-Aviation.png",
        "torpedo": "https://azurlane.koumakan.jp/w/images/thumb/4/40/Torpedo.png/25px-Torpedo.png"
    };

    // An object containing ALL ship data. This is a large variable.
    var ship_db = {};

    var searchTextCache = "";

    /**
     * Gets the index of the nth occurance of a substring in a string.
     * This solution was deprived from StackOverflow, original answer found here:
     * https://stackoverflow.com/a/14482123
     * */
    function nthIndex(str, pat, n) {
        var L = str.length, i = -1;
        while (n-- && i++ < L) {
            i = str.indexOf(pat, i);
            if (i < 0) break;
        }
        return i;
    }

    /**
     * Renders the ship display case with the given ship.
     */
    function renderShipDisplayCase(shipName){
        $("#search").val("");
        var shipChunk = ship_db[shipName];
        $("#ship_displayCase").show();
        $("#ship_displayCase_name").html(shipName + " <small><small><small>(CN: " + shipChunk["detailedItems"]["CNName"] + "; JP: " + shipChunk["detailedItems"]["JPName"] + ")</small></small></small>");
        //$("#rawDATA").text(JSON.stringify(ship_db[shipName]));
    }

    /**
     * Parses the list of ships given the wikimedia HTML parse data for https://azurlane.koumakan.jp/List_of_Ships.
     * This is hard-coded, and therefore is subject to breaking. Will attempt to update as often as possible.
     * Developed by @HotFireyDeath (Chen Zheng)
     * https://czheng.me
     */
    function parseListOfShips(data) {
        var ships = {};
        // Parse ship's 'top layer' data using List of Ships Azur Wiki result.
        for (var i = 0; i < data.length; i++) {
            if ((i + 1) < data.length) { // Check for out of bounds.
                if (
                    data[i].includes("td data-sort-value=") &&
                    data[i + 1].includes("a href=\"") &&
                    (isNaN(data[i + 1].substring(data[i + 1].indexOf(">") + 1)) || (parseInt(data[i + 1].substring(data[i + 1].indexOf(">") + 1)) < 3000))
                ) {
                    var shipName = (data[i + 1].substring(9, nthIndex(data[i + 1], "\"", 2))).replace(/_/g, " ");
                    ships[shipName] = {
                        pageLink: "/" + shipName.replace(/ /g, "_"), // Ship Wikimedia page
                        id: data[i + 1].substring(data[i + 1].indexOf(">") + 1), // Ship ID
                        category: data[i + 11].substring(data[i + 11].indexOf(">") + 1),
                        rarity: data[i + 8].substring(data[i + 8].indexOf(">") + 1),
                        affiliation: data[i + 15].substring(data[i + 15].indexOf(">") + 1),
                        firepower_rating: data[i + 18].substring(data[i + 18].indexOf(">") + 1),
                        health_rating: data[i + 20].substring(data[i + 20].indexOf(">") + 1),
                        anti_air_rating: data[i + 22].substring(data[i + 22].indexOf(">") + 1),
                        evasion_rating: data[i + 24].substring(data[i + 24].indexOf(">") + 1),
                        air_power_rating: data[i + 26].substring(data[i + 26].indexOf(">") + 1),
                        torpedo_rating: data[i + 28].substring(data[i + 28].indexOf(">") + 1)
                    }
                }
            }
        }
        document.title = "0";
        // Deep search for each ship, grab available stats.
        for (var name in ships) {
            //var name = "Universal Bullin";
            var shipNameTag = ships[name]["pageLink"].substring(1);
            document.title = (parseInt(document.title) + 1) + "";
            $.ajax({
                url: "https://azurlane.koumakan.jp/w/api.php",
                method: "GET",
                dataType: "jsonp",
                data: {
                    action: "parse",
                    page: shipNameTag,
                    prop: "wikitext",
                    format: "json"
                },
                success: function (data) {
                    document.title = (parseInt(document.title) - 1) + "";
                    var raw = data["parse"]["wikitext"]["*"];
                    raw = raw.split("|");

                    // Reverse search ships by matching ID.
                    var currentShipID = raw[1].split("=")[1].trim();
                    for (var s in ships) {
                        if (ships[s]["id"] === currentShipID) {
                            ships[s]["detailedItems"] = {};
                            raw.forEach(function (item) {
                                var twig = item.split("=");
                                if (twig.length === 2) {
                                    // Remove format whitespacing.
                                    twig[0] = twig[0].trim();
                                    twig[1] = twig[1].trim();
                                    ships[s]["detailedItems"][twig[0]] = twig[1];
                                }
                            });
                        }
                    }
                }
            });
        }

        // Essentially, waits until the ajaxes (above) are done, and then saves the data.
        var interval = window.setInterval(function () {
            if (document.title === "0") {
                // All data received, now parse and render.
                document.title = "AzurViewer";
                $("#loading_pleaseWait").hide();
                $("#omnisearch").show();
                ship_db = ships;

                clearInterval(interval);
            }
            else if ((document.readyState === "complete") && ["AzurViewer", "0"].indexOf(document.title) === -1) {
                alert("Unable to fetch data. Retrying...");
                location.reload();
            }
        }, 500);
    }

    $.ajax({
        url: "https://azurlane.koumakan.jp/w/api.php",
        method: "GET",
        dataType: "jsonp",
        data: {
            action: "parse",
            page: "List_of_Ships",
            format: "json"
        },
        success: function (data) {
            // text variable contains a fragment of HTML.
            var text = data['parse']['text']['*'];
            text = text.split("<");
            parseListOfShips(text);
        }
    });

    // Makes the search results appear and disappear as search is focused.
    window.setInterval(function () {
        var search = $("#search");
        if (search.is(":focus") && (search.val().length > 0)) {
            $("#search_results").show();
            $("#ship_displayCase").hide();
        }
        else {
            $("#search_results").hide();
        }
    }, 500);

    // Search functionality (WIP)
    window.setInterval(function () {

        var searchResult = $("#search").val();

        if (searchResult !== searchTextCache) {
            searchTextCache = searchResult;
            // clear current results
            var node = document.getElementById("search_results");
            while (node.firstChild) {
                node.removeChild(node.firstChild);
            }
            if (searchResult.length > 0) {
                if (searchResult.toLowerCase() === "help") {
                    var helpData = {
                        "regular search" : "Enter text and search results will appear based on ship name.",
                        "compare" : "Compares named ships' stats. <a onclick='$(\"#search\").val(\"compare prinz eugen, belfast, universal bullin\");' style='cursor: pointer;'>Click for an example</a>",
                        "help" : "Shows all possible commands."
                    };
                    for (var name in helpData){
                        var parent = document.getElementById("search_results");
                        var newListElement = document.createElement("LI");
                        newListElement.className = "collection-item";
                        newListElement.innerHTML = name + " : " + helpData[name];
                        parent.appendChild(newListElement);
                    }
                }
                else {
                    var shipNames = Object.keys(ship_db);
                    shipNames.forEach(function (item) {
                        if (item.toLowerCase().indexOf(searchResult.toLowerCase()) !== -1) {
                            // add to search_results
                            var parent = document.getElementById("search_results");
                            var newListElement = document.createElement("LI");
                            newListElement.className = "collection-item";
                            newListElement.innerHTML = "<a onclick='renderShipDisplayCase(\"" + item + "\")' style='color: black; text-decoration: none; cursor: pointer;'>" + item + "</a>";
                            parent.appendChild(newListElement);
                        }
                    });
                }
            }
        }

    }, 500);

</script>
</body>
</html>
