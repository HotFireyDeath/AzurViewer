<!DOCTYPE html>

<!-- 

AzurViewer

[ A web explorer for Azur Lane. Look at detailed ship stats, descriptions and more. ]

-------

What is the license?
Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0), as stated with Wikimedia-related content unless stated otherwise.
See link for more details: https://creativecommons.org/licenses/by-nc-sa/4.0/

How does it work?
Essentially, the app scrapes data from the wiki and parses it correctly into an app. This removes the need to rewrite tons and tons of 
existing information. (phew). Of course, too many requests will flood the wiki, so data is attempted caching into localStorage.

Developed by Chen Zheng (@HotFireyDeath)
-->

<html>
    <head>
        <title>AzurViewer</title>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    </head>
    <body>
        <p id="shipItems">

        </p>
        <br>
        <p id="temp">

        </p>
        <script>

            // An object containing the URL to useful icons.
            var icons = {
                "firepower": "https://azurlane.koumakan.jp/w/images/thumb/d/d5/Firepower.png/25px-Firepower.png",
                "health": "https://azurlane.koumakan.jp/w/images/thumb/8/8b/Duration.png/25px-Duration.png",
                "anti_air": "https://azurlane.koumakan.jp/w/images/thumb/0/0f/AntiAir.png/25px-AntiAir.png",
                "evasion": "https://azurlane.koumakan.jp/w/images/thumb/d/d2/Evasion.png/25px-Evasion.png",
                "air_power": "https://azurlane.koumakan.jp/w/images/thumb/6/6a/Aviation.png/25px-Aviation.png",
                "aviation": "https://azurlane.koumakan.jp/w/images/thumb/6/6a/Aviation.png/25px-Aviation.png",
                "torpedo": "https://azurlane.koumakan.jp/w/images/thumb/4/40/Torpedo.png/25px-Torpedo.png"
            };

            /**
             Gets the index of the nth occurance of a substring in a string.

             This solution was deprived from StackOverflow, original answer found here:
             https://stackoverflow.com/a/14482123
             */
            function nthIndex(str, pat, n) {
                var L = str.length, i = -1;
                while (n-- && i++ < L) {
                    i = str.indexOf(pat, i);
                    if (i < 0) break;
                }
                return i;
            }

            /**
             Parses the list of ships given the wikimedia HTML parse data for https://azurlane.koumakan.jp/List_of_Ships.
             This is hard-coded, and therefore is subject to breaking. Will attempt to update as often as possible.

             Developed by @HotFireyDeath (Chen Zheng)
             https://czheng.me
             */
            function parseListOfShips(data) {
                var ships = {};

                // Parse ship's 'top layer' data using List of Ships Azur Wiki result.
                for (var i = 0; i < data.length; i++) {
                    if ((i + 1) < data.length) { // Check for out of bounds.
                        if (
                            data[i].includes("td data-sort-value=") &&
                            data[i + 1].includes("a href=\"") &&
                            (isNaN(data[i + 1].substring(data[i + 1].indexOf(">") + 1)) || (parseInt(data[i + 1].substring(data[i + 1].indexOf(">") + 1)) < 3000))
                        ) {
                            var shipName = (data[i + 1].substring(9, nthIndex(data[i + 1], "\"", 2))).replace(/_/g, " ");
                            ships[shipName] = {
                                pageLink: "/" + shipName.replace(/ /g, "_"), // Ship Wikimedia page
                                id: data[i + 1].substring(data[i + 1].indexOf(">") + 1), // Ship ID
                                category: data[i + 11].substring(data[i + 11].indexOf(">") + 1),
                                rarity: data[i + 8].substring(data[i + 8].indexOf(">") + 1),
                                affiliation: data[i + 15].substring(data[i + 15].indexOf(">") + 1),
                                firepower_rating: data[i + 18].substring(data[i + 18].indexOf(">") + 1),
                                health_rating: data[i + 20].substring(data[i + 20].indexOf(">") + 1),
                                anti_air_rating: data[i + 22].substring(data[i + 22].indexOf(">") + 1),
                                evasion_rating: data[i + 24].substring(data[i + 24].indexOf(">") + 1),
                                air_power_rating: data[i + 26].substring(data[i + 26].indexOf(">") + 1),
                                torpedo_rating: data[i + 28].substring(data[i + 28].indexOf(">") + 1)
                            }
                        }
                    }
                }

                document.title = "0";

                // Deep search for each ship, grab available stats.
                //for (var name in ships) {
                    var name = "Universal Bullin";
                    var shipNameTag = ships[name]["pageLink"].substring(1);
                    document.title = (parseInt(document.title) + 1) + "";
                    $.ajax({
                        url: "https://azurlane.koumakan.jp/w/api.php",
                        method: "GET",
                        dataType: "jsonp",
                        data: {
                            action: "parse",
                            page: shipNameTag,
                            prop: "wikitext",
                            format: "json"
                        },
                        success: function (data) {
                            document.title = (parseInt(document.title) - 1) + "";
                            var raw = data["parse"]["wikitext"]["*"];
                            raw = raw.split("|");
                            $("#temp").text(JSON.stringify(raw));
                            // TO-DO: Parse raw data to ships.
                        }
                    });
                //}

                // Essentially, waits until the ajaxes (above) are done, and then renders the page.
                var interval = window.setInterval(function(){
                    if (document.title === "0"){
                        render(ships);
                        clearInterval(interval);
                    }
                }, 1000);
            }

            function render(ships){
                $("#shipItems").text(JSON.stringify(ships));
            }

            $.ajax({
                url: "https://azurlane.koumakan.jp/w/api.php",
                method: "GET",
                dataType: "jsonp",
                data: {
                    action: "parse",
                    page: "List_of_Ships",
                    format: "json"
                },
                success: function (data) {
                    // text variable contains a fragment of HTML.
                    var text = data['parse']['text']['*'];
                    text = text.split("<");
                    /*

                    Code slice is for testing purposes only. Prints out a big list.

                    text = text.split("<");
                    text.forEach(function(item, index){
                      $("#item").html($("#item").html() + index + " " + item + "<br>");
                    });
                    */

                    var parsedShips = parseListOfShips(text);
                }
            });
        </script>
    </body>
</html>
