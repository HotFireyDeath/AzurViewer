<!DOCTYPE html>

<!-- 
AzurViewer
[ A web explorer for Azur Lane. Look at detailed ship stats, descriptions and more. ]

Developed by Chen Zheng (@HotFireyDeath)
http://czheng.me
-->

<html>
<head>
    <title>AzurViewer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="manifest.json">

    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"
          integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">

    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

    <!-- JQUERY -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <!-- MATERIALIZE -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- LOCALFORAGE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.7.2/localforage.min.js"></script>

    <style>
        body {
            font-family: "Open Sans", serif;
        }

        /*
            Below is a solution to fit an image to the page responsively.
            The solution can be found at:
            https://stackoverflow.com/a/14696457
        */
        * {
            margin: 0;
            padding: 0;
        }

        .imgbox {
            display: grid;
            height: 100%;
        }

        .center-fit {
            max-width: 100%;
            max-height: 100vh;
            margin: auto;
        }

        a {
            cursor: pointer;
        }

        /*
            Below is a solution to fit 5 columns in a grid in Materialize.
            The solution can be found at:
            https://stackoverflow.com/a/43084048
         */
        .s5ths,
        .m5ths,
        .l5ths,
        .xl5ths {
            margin-left: auto;
            left: auto;
            right: auto;
        }

        .row .col.s5ths {
            width: 20%;
        }

        @media only screen and (min-width: 601px) {
            .row .col.m5ths {
                width: 20%;
            }
        }

        @media only screen and (min-width: 993px) {
            .row .col.l5ths {
                width: 20%;
            }
        }

        @media only screen and (min-width: 1201px) {
            .row .col.xl5ths {
                width: 20%;
            }
        }
    </style>
</head>
<body>

<!-- omnisearch -->
<nav id="omnisearch" style="display: none;">
    <div class="nav-wrapper blue darken-1">
        <form>
            <div class="input-field">
                <input id="search" type="search" placeholder="Type 'help' for navigation options">
                <label class="label-icon" for="search"><i class="fas fa-search"></i></label>
                <i class="material-icons fas fa-times" onclick="$('#search').val('');"></i>
            </div>
        </form>
    </div>
</nav>

<!-- search results list -->
<div class="container">
    <ul class="collection" id="search_results" style="display: none;"></ul>
</div>

<!-- loading element -->
<div id="loading_pleaseWait" style="display: none;">
    <div class="container">
        <div class="card horizontal">
            <div class="card-image">
                <img id="loading_pleaseWait_char" src="https://azurlane.koumakan.jp/w/images/f/fb/SaratogaChibi.png">
            </div>
            <div class="card-stacked">
                <div class="card-content" style="text-align: center;" id="loading_pleaseWait_phrase">
                    <span id="loading_pleaseWait_percentage" style="font-size: 10px;"></span>
                    <span class="card-title">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- main page element -->
<div id="mainMenuDisplay" class="container" style="display: none;">
    <br>
</div>

<!-- ship display element -->
<div id="ship_displayCase" style="display: none;">
    <div class="container">
        <p id="ship_displayCase_rawData"></p> <!-- rawData div will only be filled for development purpose. -->

        <br><button class="waves-effect waves-teal btn-flat" onclick="document.title='AzurViewer';$('#ship_displayCase').hide();$('#mainMenuDisplay').show();"><i class="fas fa-angle-left"></i> Back</button>
        
        <!-- ship name -->
        <h4 id="ship_displayCase_name" style="text-align: center;" onclick="checkClick();"></h4>
        <!-- ship skin display -->
        <div class="imgbox"><img onclick="displaySkinModal();" class="center-fit" id="ship_displayCase_skinpicture"
                                 src="https://azurlane.koumakan.jp/w/images/0/06/Akagi.png"></div>
        <!-- ship basic info -->
        <ul class="collection">
            <li id="ship_displayCase_nationality" class="collection-item"></li>
            <li id="ship_displayCase_rarity" class="collection-item"></li>
            <li id="ship_displayCase_constructionTime" class="collection-item"></li>
            <li id="ship_displayCase_class" class="collection-item"></li>
            <li id="ship_displayCase_hullType" class="collection-item"></li>
            <li id="ship_displayCase_id" class="collection-item"></li>
            <li id="ship_displayCase_clickMiscInfo" class="collection-item"
                style="background-color: whitesmoke; cursor: pointer;" onclick="$('#miscInfoModal').modal('open');">
                <small>Click for misc. info</small>
            </li>
        </ul>

        <!-- ship stats -->
        <div class="card">
            <div class="card-tabs">
                <ul class="tabs tabs-fixed-width">
                    <li class="tab"><a onclick="changeStats('Kai');">Lv. 100 Retrofit</a></li>
                    <li class="tab"><a onclick="changeStats('Max');">Lv. 100</a></li>
                    <li class="tab"><a onclick="changeStats('Kai120');">Lv. 120 Retrofit</a></li>
                    <li class="tab"><a onclick="changeStats('120');">Lv. 120</a></li>
                    <li class="tab"><a onclick="changeStats('Initial');">Base</a></li>
                </ul>
            </div>
            <div class="card-content grey lighten-5">
                <ul class="collection">
                    <li class="collection-item avatar">
                        <img src="https://azurlane.koumakan.jp/w/images/thumb/8/8b/Duration.png/25px-Duration.png"
                             class="circle">
                        <span class="title">Health</span>
                        <p id="ship_displayCase_health"></p>
                    </li>
                    <li class="collection-item avatar">
                        <img src="https://azurlane.koumakan.jp/w/images/thumb/0/06/Armor.png/25px-Armor.png"
                             class="circle">
                        <span class="title">Armor Type</span>
                        <p id="ship_displayCase_armorType"></p>
                    </li>
                    <li class="collection-item avatar">
                        <img src="https://azurlane.koumakan.jp/w/images/thumb/e/e3/Refill.png/25px-Refill.png"
                             class="circle">
                        <span class="title">Reload</span>
                        <p id="ship_displayCase_reload"></p>
                    </li>
                    <li class="collection-item avatar">
                        <img src="https://azurlane.koumakan.jp/w/images/thumb/d/d5/Firepower.png/25px-Firepower.png"
                             class="circle">
                        <span class="title">Firepower</span>
                        <p id="ship_displayCase_fire"></p>
                    </li>
                    <li class="collection-item avatar">
                        <img src="https://azurlane.koumakan.jp/w/images/thumb/4/40/Torpedo.png/25px-Torpedo.png"
                             class="circle">
                        <span class="title">Torpedo</span>
                        <p id="ship_displayCase_torp"></p>
                    </li>
                    <li class="collection-item avatar">
                        <img src="https://azurlane.koumakan.jp/w/images/thumb/d/d2/Evasion.png/25px-Evasion.png"
                             class="circle">
                        <span class="title">Evasion</span>
                        <p id="ship_displayCase_evade"></p>
                    </li>
                    <li class="collection-item avatar">
                        <img src="https://azurlane.koumakan.jp/w/images/thumb/0/0f/AntiAir.png/25px-AntiAir.png"
                             class="circle">
                        <span class="title">Anti-Air</span>
                        <p id="ship_displayCase_aa"></p>
                    </li>
                    <li class="collection-item avatar">
                        <img src="https://azurlane.koumakan.jp/w/images/thumb/6/6a/Aviation.png/25px-Aviation.png"
                             class="circle">
                        <span class="title">Air Power</span>
                        <p id="ship_displayCase_air"></p>
                    </li>
                    <li class="collection-item avatar">
                        <img src="https://azurlane.koumakan.jp/w/images/thumb/9/90/Consumption.png/25px-Consumption.png"
                             class="circle">
                        <span class="title">Oil consumption</span>
                        <p id="ship_displayCase_consumption"></p>
                    </li>
                    <li class="collection-item avatar">
                        <img src="https://azurlane.koumakan.jp/w/images/thumb/1/16/ASW.png/25px-ASW.png" class="circle">
                        <span class="title">Anti-submarine warfare</span>
                        <p id="ship_displayCase_asw"></p>
                    </li>
                </ul>
                <ul class='collection'>
                    <li class='collection-item' id='ship_displayCase_speed'></li>
                    <li class='collection-item' id='ship_displayCase_reinforce'></li>
                    <li class='collection-item' id='ship_displayCase_scrapIncome'></li>
                </ul>
            </div>
        </div>

        <!-- ship equipment slots -->

        <!-- collection and voice lines collapsible -->
        <ul class="collapsible">
            <li>
                <div class="collapsible-header"><i class="fas fa-wrench"></i> Equipment</div>
                <div class="collapsible-body" id="ship_displayCase_equipmentPanel"></div>
            </li>
            <li>
                <div class="collapsible-header"><i class="fas fa-cogs"></i> Construction</div>
                <div class="collapsible-body">
                    <div class="row" style="text-align: center;">
                        <div class="col m5ths s6" id="ship_displayCase_lightCraftable"></div>
                        <div class="col m5ths s6" id="ship_displayCase_heavyCraftable"></div>
                        <div class="col m5ths s6" id="ship_displayCase_aviationCraftable"></div>
                        <div class="col m5ths s6" id="ship_displayCase_limitedCraftable"></div>
                        <div class="col m5ths s6" id="ship_displayCase_exchangeCraftable"></div>
                    </div>
                    <ul class="collection" id="ship_displayCase_dropLocations"></ul>
                </div>
            </li>
            <li>
                <div class="collapsible-header"><i class="far fa-comment"></i> Voice Lines</div>
                <div class="collapsible-body"><i>Coming soon...</i> <!-- WIP --></div>
            </li>
        </ul>
    </div>
</div>

<!-- modals -->
<div id="skinModal" class="modal">
    <div class="modal-content">
        <h4>Select a skin: </h4>
        <ul class="collection" id="skinModal_list"></ul>
    </div>
</div>

<div id="miscInfoModal" class="modal">
    <div class="modal-content">
        <h4>Misc. Info</h4>
        <ul class="collection">
            <li id="miscInfoModal_artist" class="collection-item"></li>
            <li id="miscInfoModal_voiceActress" class="collection-item"></li>
        </ul>
        <button class="waves-effect waves-blue btn-flat"
                onclick="window.open('https://azurlane.koumakan.jp/' + document.title.replace(/ /g, '_'), '_blank');">
            Open in Wiki
        </button>
    </div>
</div>
<!-- !modals -->

<script>

    // Development raw data name clicker.
    var devClicks = 0;

    function checkClick() {
        if (devClicks === 20) {

            $("#ship_displayCase_rawData").text(JSON.stringify(ship_db[document.title]));
            devClicks = 0;
        }
        else {
            devClicks++;
        }
    }

    /**
     * Gets the key corresponding to the value in object.
     * Original solution found here: https://stackoverflow.com/a/28191966
     */
    function getKeyByValue(object, value) {
        return Object.keys(object).find(key => object[key] === value);
    }

    // Set random loading character and 'slogan'.
    var loadingRandoms = {
        "https://azurlane.koumakan.jp/w/images/8/86/LaffeyChibi.png": "Commander... wait here (yawn)...",
        "https://azurlane.koumakan.jp/w/images/f/fb/SaratogaChibi.png": "Commander, please wait a moment~",
        "https://azurlane.koumakan.jp/w/images/0/08/AyanamiChibi.png": "Please wait a second, commander...",
        "https://azurlane.koumakan.jp/w/images/8/84/BelfastChibi.png": "Pardon me, Commander, but you will have to wait a second. In the meantime, would you like some tea?",
        "https://azurlane.koumakan.jp/w/images/7/70/AkashiChibi.png": "Commander, wait here while I examine the site meow...",
        "https://azurlane.koumakan.jp/w/images/e/e7/UnicornChibi.png": "Big brother... Unicorn will stay with you while you wait...",
        "https://azurlane.koumakan.jp/w/images/2/2c/Ning_HaiChibi.png": "I wonder if the fleet's expenses can be covered by this site...",
        "https://azurlane.koumakan.jp/w/images/f/f5/AjaxChibi.png": "My precious little piggy, let me step on your face~"
    };
    // This is a slightly modified version of the solution found here: https://stackoverflow.com/a/15106541
    var randomKey = function (loadingRandoms) {
        var keys = Object.keys(loadingRandoms);
        return keys[keys.length * Math.random() << 0];
    };
    randomKey = randomKey(loadingRandoms);
    $("#loading_pleaseWait_char").attr("src", randomKey);
    var phrase = $("#loading_pleaseWait_phrase");
    phrase.html(phrase.html() + loadingRandoms[randomKey]);

    // An object containing ALL ship data. This is a large variable.
    var ship_db = {};

    // An object containing ALL resource data. This is a fairly large variable.
    var resource_db = {};

    var searchTextCache = '';

    /**
     * Gets the index of the nth occurance of a substring in a string.
     * This solution was deprived from StackOverflow, original answer found here:
     * https://stackoverflow.com/a/14482123
     * */
    function nthIndex(str, pat, n) {
        var L = str.length, i = -1;
        while (n-- && i++ < L) {
            i = str.indexOf(pat, i);
            if (i < 0) break;
        }
        return i;
    }
    
    function showMainMenu(){
        
        // create a row.
        var row = $('<div class="row"></div>');
        
        var shipNames = Object.keys(ship_db);
        shipNames.forEach(function(item){
            var col = $('<div class="col s4"></div>');
            col.html(
                '<div class="card horizontal" style="cursor: pointer;" onclick="renderShipDisplayCase(\'' + item + '\');">' + 
                '<div class="card-image"><img src="' + resource_db[item.replace(/ /g, "_") + 'Icon.png'] + '"></div>' + 
                '<div class="card-stacked"><div class="card-content"><h6>' + item + '</h6></div></div></div>'
                );
            row.append(col);
            if (row.children().length === 3){
                $('#mainMenuDisplay').append(row);
                row = $('<div class="row"></div>');
            }
        });
        
        $('#mainMenuDisplay').show();
    }

    /**
     * Displays the skins for the current ship in a modal.
     */
    function displaySkinModal() {

        // Remove previous results (visual).
        var node = document.getElementById('skinModal_list');
        while (node.firstChild) {
            node.removeChild(node.firstChild);
        }

        // Search and list all skins.
        var shipName = document.title.replace(/ /g, "_");
        for (var fileName in resource_db) {
            if (fileName.indexOf(shipName) !== -1) {
                var extension = fileName.split('.').pop(); // gets the file extension.
                if (extension === 'png') {
                    var filter = false; // If picture matches filter, we can add to skin list.

                    var skinName = fileName.replace('.png', ' ');
                    skinName = skinName.replace(document.title.replace(/ /g, "_"), '');
                    if (skinName.trim().length > 0) {
                        var sufKey = getKeyByValue(ship_db[document.title]['detailedItems'], skinName.trim());
                        if (sufKey && (sufKey.indexOf('Suffix') !== -1)) {
                            skinName = ship_db[document.title]['detailedItems'][sufKey.replace('Suffix', 'Name')];
                            filter = true;
                        }
                        else {
                            if ((skinName.indexOf('Kai') !== -1) && (skinName.replace('Kai', '').replace(document.title.replace(/ /g, "_"), '').trim().length === 0)) {
                                skinName = "Retrofit";
                                filter = true;
                            }
                        }
                    }
                    else {
                        skinName = fileName.replace('.png', ' ');
                        if (skinName.trim() === document.title.replace(/ /g, "_")) {
                            skinName = "Default";
                            filter = true;
                        }
                    }

                    if (filter) {
                        var parent = document.getElementById('skinModal_list');
                        var child = document.createElement('LI');
                        child.className = 'collection-item';
                        child.innerHTML = '<a onclick="forceSkin(\'' + fileName + '\');" style="color: black; text-decoration: none; cursor: pointer;">' + skinName + '</a>';
                        parent.appendChild(child);
                    }
                }
            }
        }

        // Display modal after all the work is done.
        var sm = $('#skinModal');
        sm.modal('open');
    }

    /**
     * Force loads a skin into the viewer given a file key.
     */
    function forceSkin(fileKey) {
        var sp = $("#ship_displayCase_skinpicture");
        sp.hide();
        sp.ready(function () {
            $("#ship_displayCase_skinpicture").show();
        });
        sp.attr("src", resource_db[fileKey]);

        // Since this method is only used for skin loading, close skin modal once processing.
        $('#skinModal').modal('close');
    }

    /**
     * Renders the ship display case with the given ship.
     */
    function renderShipDisplayCase(shipName) {

        document.title = shipName;
        
        // General display and name.
        $("#search").val("");
        var shipChunk = ship_db[shipName];
        $("#ship_displayCase").show();
        $("#ship_displayCase_name").html(shipName + " <small><small><small>(CN: " + shipChunk["detailedItems"]["CNName"] + "; JP: " + shipChunk["detailedItems"]["JPName"] + ")</small></small></small>");

        // Skin image
        var sp = $("#ship_displayCase_skinpicture");
        sp.hide();
        sp.ready(function () {
            $("#ship_displayCase_skinpicture").show();
        });
        sp.attr("src", resource_db[shipName.replace(/ /g, "_") + ".png"]);

        // Ship general attributes and misc info.
        var nationality = shipChunk["detailedItems"]["Nationality"];//detailedItems is more accurate to read from
        var rarity = shipChunk["detailedItems"]["Rarity"];
        var constructionTime = shipChunk["detailedItems"]["ConstructTime"];
        var clas = shipChunk["detailedItems"]["Class"];
        var hullType = shipChunk["detailedItems"]["Type"];
        var id = shipChunk["detailedItems"]["ID"];
        var nationalityColorTypes = {
            "Sakura Empire": "pink",
            "Eagle Union": "dodgerblue",
            "Royal Navy": "lightblue",
            "Ironblood": "lightcoral",
            "Eastern Radiance": "hotpink",
            "North Union": "lightgray",
            "Iris Libre": "gold",
            "Vichya Dominion": "italianred"
        };
        var rarityColorTypes = {
            "Normal": "lightgray",
            "Rare": "lightblue",
            "Elite": "#B19CD9",
            "Super Rare": "#FFE974"
        };
        var n = $("#ship_displayCase_nationality");
        n.css("background-color", nationalityColorTypes[nationality]);
        n.html("<small>Nationality</small> " + nationality);
        var r = $("#ship_displayCase_rarity");
        if (rarity === "Ultra Rare") {
            // Ultra Rare gradient (very close to wiki gradient).
            r.css({
                'background-image': 'linear-gradient(to right, #FFB2B2, #F5D4BC, #FFF4A5, #C9FD94, #AEDDFF, #CAAEFF)',
                'background-color': ''
            });
        }
        else {
            r.css({
                "background-color": rarityColorTypes[rarity],
                'background-image': ''
            });
        }
        r.html("<small>Rarity</small> " + rarity);
        $("#ship_displayCase_constructionTime").html("<small>Construction Time</small> " + constructionTime);
        $("#ship_displayCase_class").html("<small>Class</small> " + clas);
        $("#ship_displayCase_hullType").html("<small>Hull Type</small> " + hullType);
        $("#ship_displayCase_id").html("<small>ID</small> " + id);

        // Ship misc info modal.
        $('#miscInfoModal_artist').html("<small>Artist</small> <a target='_blank' href='" + shipChunk['detailedItems']['ArtistLink'].replace('[', '').replace(']', '').replace(shipChunk['detailedItems']['Artist'], '') +
            "'>" + shipChunk['detailedItems']['Artist'] + "</a>");
        var VAchunk = shipChunk['detailedItems']['VA']; // have to process this before putting into HTML.
        VAchunk = VAchunk.replace('[', '').replace(']', '').replace('https://en.wikipedia.org/wiki/', '');
        VAchunk = VAchunk.substring(0, VAchunk.indexOf(' '));
        VAchunk = decodeURIComponent(VAchunk);
        var VAlink = 'https://en.wikipedia.org/wiki/' + encodeURIComponent(VAchunk);
        $('#miscInfoModal_voiceActress').html("<small>Voice Actress</small> <a target='_blank' href='" + VAlink + "'>" + VAchunk.replace('_', ' ') + "</a>");

        // Ship reinforcement and scrap income 
        var fphtml = '<img src="https://azurlane.koumakan.jp/w/images/thumb/d/d5/Firepower.png/25px-Firepower.png">';
        var torphtml = '<img src="https://azurlane.koumakan.jp/w/images/thumb/4/40/Torpedo.png/25px-Torpedo.png">';
        var aviahtml = '<img src="https://azurlane.koumakan.jp/w/images/thumb/6/6a/Aviation.png/25px-Aviation.png">';
        var reloadhtml = '<img src="https://azurlane.koumakan.jp/w/images/thumb/e/e3/Refill.png/25px-Refill.png">';
        var coinhtml = '<img src="https://azurlane.koumakan.jp/w/images/thumb/c/c4/Coinicon.png/25px-Coinicon.png">';
        var oilhtml = '<img src="https://azurlane.koumakan.jp/w/images/thumb/f/f2/Oilicon.png/25px-Oilicon.png">';
        var medalhtml = '<img src="https://azurlane.koumakan.jp/w/images/thumb/3/33/Medalicon.png/20px-Medalicon.png">';
        var scrapValues = shipChunk['detailedItems']['ScrapIncome']
            .replace('{{coin}}', '')
            .replace('{{oil}}', '')
            .replace('{{Medal}}', '')
            .split(' ');
        var reinforcementValues = shipChunk['detailedItems']['ReinforcementValue']
            .replace('{{Firepower}}', '')
            .replace('{{Torpedo}}', '')
            .replace('{{Aviation}}', '')
            .replace('{{RoF}}', '')
            .split('  ');
        // reinforce, scrapIncome
        $('#ship_displayCase_reinforce').html('<small>Reinforcement Value</small> ' + reinforcementValues[0] + ' ' + fphtml + ', ' + reinforcementValues[1] + ' ' + torphtml + ', ' + reinforcementValues[2] + ' ' + aviahtml + ', ' + reinforcementValues[3] + ' ' + reloadhtml);
        $('#ship_displayCase_scrapIncome').html('<small>Scrap Income</small> ' + scrapValues[0] + ' ' + coinhtml + ', ' + scrapValues[1] + ' ' + oilhtml + ', ' + scrapValues[2] + ' ' + medalhtml);

        // Ship equipment.
        var ep = $('#ship_displayCase_equipmentPanel');
        ep.empty();
        ep.html("<div class=\"row\"><div class=\"col s4\"><b>Slot</b></div><div class=\"col s4\"><b>Efficiency</b></div><div class=\"col s4\"><b>Equippable</b></div></div>");
        var ableToRender = [];
        for (var i = 1; i <= 5; i++) {
            if (('Eq' + i + 'EffInit' in shipChunk['detailedItems']) && ('Eq' + i + 'EffInitMax' in shipChunk['detailedItems'])) {
                // Both EffInit and EffMax keys exist, check if they are full and add to render array if full.
                if ((shipChunk['detailedItems']['Eq' + i + 'EffInit'].length > 0) && (shipChunk['detailedItems']['Eq' + i + 'EffInitMax'].length > 0)) {
                    ableToRender.push('Eq' + i);
                }
            }
        }
        ableToRender.forEach(function (item, index) {
            var row = $('<div></div>');
            row.addClass('row');

            // Create the three col items.
            var slotNum = $('<div></div>');
            slotNum.addClass('col s4');
            slotNum.html(index);

            var efficiencyVal = $('<div></div>');
            efficiencyVal.addClass('col s4');
            efficiencyVal.html(shipChunk['detailedItems'][item + 'EffInit'] + '/' + shipChunk['detailedItems'][item + 'EffInitMax']);
            if ((item + 'EffInitKai' in shipChunk['detailedItems']) && (shipChunk['detailedItems'][item + 'EffInitKai'].length > 0)) {
                efficiencyVal.html(efficiencyVal.html() + '/' + shipChunk['detailedItems'][item + 'EffInitKai']);
            }

            var equipType = $('<div></div>');
            equipType.addClass('col s4');
            equipType.html(shipChunk['detailedItems'][item + 'Type']);

            // Append the three to row, and then append row to panel. Redo for possible of 5 times per ship.
            row.append(slotNum, efficiencyVal, equipType);
            ep.append(row);
        });

        // Ship construction
        var constructTypes = ["Light", "Heavy", "Aviation", "Limited", "Exchange"];
        constructTypes.forEach(function(item, index){
            var test = false;
            if (('D' + item in shipChunk['detailedItems'])){
                if (shipChunk['detailedItems']['D' + item] === '1'){
                    test = true;
                }
            }
            var target = $('#ship_displayCase_' + item.toLowerCase() + 'Craftable');
            var note = "";
            var attr = "";
            if (('D' + item + 'Note' in shipChunk['detailedItems'])){
                note += shipChunk['detailedItems']['D' + item + 'Note'];
            }
            if (note.length > 0){
                attr += 'class="tooltipped" data-position="top" data-tooltip="' + note + '"';
            }

            if (test){
                target.empty();
                target.append('<b ' + attr + '>' + item + '</b>' + '<br><i class="fas fa-check"></i>');
            }
            else{
                target.empty();
                target.append('<b ' + attr + '>' + item + '</b>' + '<br><i class="fas fa-times"></i>');
            }
        });

        var locs = Object.keys(shipChunk['detailedItems']);
        var rlocs = [];
        locs.forEach(function(item){
            if (item.charAt(0) === 'D') rlocs.push(item);
        });
        locs = [];
        rlocs.forEach(function(item){
            if (!isNaN(item.charAt(1))){
                // D[somenumber] so should be a map entry.
                locs.push(item);
            }
        });
        var chapters = {};
        locs.forEach(function(item){
            var chopD = item.replace('D', '');
            var split = chopD.split('-');
            if (!(split[0] in chapters)){
                chapters[split[0]] = [];
            }
            chapters[split[0]].push(split[1]);
        });

        var chapterArray = Object.keys(chapters);
        var col = $('#ship_displayCase_dropLocations');
        col.empty();
        chapterArray.forEach(function(item, index){
            var li = $('<li></li>');
            li.addClass('collection-item');
            li.html('Chapter ' + item + ': ');
            chapters[item].forEach(function(map, index){
                // Go through each chapter and see if there is a note for the map. Add as tooltip.
                var elementMeta = '';
                if (('D' + item + '-' + map in shipChunk['detailedItems']) && (shipChunk['detailedItems']['D' + item + '-' + map] !== '1')){
                    elementMeta += ' class="tooltipped" data-position="top" data-tooltip="' + shipChunk['detailedItems']['D' + item + '-' + map] + '">';
                }
                var span = $('<span' + elementMeta + '</span>');
                map = map.replace('note', '');
                if ((index + 1) === chapters[item].length){
                    span.html(map);
                }
                else{
                    span.html(map + ', ');
                }
                li.html(li.html() + span.prop('outerHTML'));
            });
            col.append(li);
        });

        // Dynamically add tooltip call for Materialize.
        $('.tooltipped').tooltip();

        changeStats('Max');
        
        // Force user to go to the top of page.
        window.scrollTo(0, 0);
    }

    /**
     * Changes the stats shown in the 'display case' for the ship.
     * type is a proper identifier such as 'Initial' or 'Kai120'.
     */
    function changeStats(type) {

        var needChunk = ship_db[document.title]['detailedItems'];

        // Display the speed value dependent only on kai or normal.
        var speed = needChunk['Speed'];
        if (type.indexOf('Kai') !== -1) {
            // retrofitted ship speed if existant.
            if (type === 'Kai120') {
                if ('SpeedKai120' in needChunk) {
                    speed = needChunk['SpeedKai120'];
                }
                else if ('SpeedKai' in needChunk) {
                    speed = needChunk['SpeedKai'];
                }
            }
            else {
                if ('SpeedKai' in needChunk) {
                    speed = needChunk['SpeedKai'];
                }
            }
        }
        $('#ship_displayCase_speed').html('<small>Speed</small> ' + speed);

        var gradeSuffix = 'Grade' + type;
        if ((type === 'Initial') || (type === 'Max') || (type === '120')) gradeSuffix = 'Grade';
        $('#ship_displayCase_armorType').text(needChunk['Armor']); // armor should be constant on all ships...
        var statItems = ['Torp', 'Fire', 'AA', 'Reload', 'Consumption', 'Air', 'Health', 'Evade', 'ASW'];
        statItems.forEach(function (item) {
            var gradeFilter = '(' + needChunk[item + gradeSuffix] + ')';

            // key exceptions (key item prefix is different than the others)
            if (item === 'Torp') {
                gradeFilter = '(' + needChunk[item + 'edo' + gradeSuffix] + ')';
            }
            else if (item === 'Air') {
                gradeFilter = '(' + needChunk['Aviation' + gradeSuffix] + ')';
            }
            else if (item === 'Evade') {
                gradeFilter = '(' + needChunk['Evasion' + gradeSuffix] + ')';
            }

            // exception cases
            if (
                (item === 'Reload') ||
                (item === 'ASW') ||
                (item === 'Consumption')
            ) {
                gradeFilter = '';
            }

            if (gradeFilter.length < 3) {
                gradeFilter = '';
            }

            $('#ship_displayCase_' + item.toLowerCase()).text(needChunk[item + type] + ' ' + gradeFilter);
        });
    }

    /**
     * Parses the list of ships given the wikimedia HTML parse data for https://azurlane.koumakan.jp/List_of_Ships.
     * This is hard-coded, and therefore is subject to breaking. Will attempt to update as often as possible.
     * Developed by @HotFireyDeath (Chen Zheng)
     * https://czheng.me
     */
    function parseListOfShips(data) {
        var ships = {};

        // Parse ship's 'top layer' data using List of Ships Azur Wiki result.
        for (var i = 0; i < data.length; i++) {
            if ((i + 1) < data.length) { // Check for out of bounds.
                if (
                    data[i].includes("td data-sort-value=") &&
                    data[i + 1].includes("a href=\"") &&
                    (isNaN(data[i + 1].substring(data[i + 1].indexOf(">") + 1)) || (parseInt(data[i + 1].substring(data[i + 1].indexOf(">") + 1)) < 3000))
                ) {
                    var shipName = (data[i + 1].substring(9, nthIndex(data[i + 1], "\"", 2))).replace(/_/g, " ");
                    ships[shipName] = {
                        pageLink: "/" + shipName.replace(/ /g, "_"), // Ship Wikimedia page
                        id: data[i + 1].substring(data[i + 1].indexOf(">") + 1), // Ship ID
                        category: data[i + 11].substring(data[i + 11].indexOf(">") + 1),
                        rarity: data[i + 8].substring(data[i + 8].indexOf(">") + 1),
                        affiliation: data[i + 15].substring(data[i + 15].indexOf(">") + 1),
                        firepower_rating: data[i + 18].substring(data[i + 18].indexOf(">") + 1),
                        health_rating: data[i + 20].substring(data[i + 20].indexOf(">") + 1),
                        anti_air_rating: data[i + 22].substring(data[i + 22].indexOf(">") + 1),
                        evasion_rating: data[i + 24].substring(data[i + 24].indexOf(">") + 1),
                        air_power_rating: data[i + 26].substring(data[i + 26].indexOf(">") + 1),
                        torpedo_rating: data[i + 28].substring(data[i + 28].indexOf(">") + 1)
                    }
                }
            }
        }
        localStorage.setItem('fullDataAmount', "0");
        localStorage.setItem('dataFetched', "0");
        // Deep search for each ship, grab available stats.
        for (var name in ships) {
            //var name = "Universal Bullin";
            var shipNameTag = ships[name]["pageLink"].substring(1);
            localStorage.setItem('fullDataAmount', (parseInt(localStorage.getItem('fullDataAmount')) + 1) + "");
            $.ajax({
                url: "https://azurlane.koumakan.jp/w/api.php",
                method: "GET",
                dataType: "jsonp",
                data: {
                    action: "parse",
                    page: shipNameTag,
                    prop: "wikitext",
                    format: "json"
                },
                success: function (data) {
                    localStorage.setItem('dataFetched', (parseInt(localStorage.getItem('dataFetched')) + 1) + "");
                    var raw = data["parse"]["wikitext"]["*"];
                    raw = raw.split("|");

                    // Reverse search ships by matching ID.
                    var currentShipID = raw[1].split("=")[1].trim();
                    for (var s in ships) {
                        if (ships[s]["id"] === currentShipID) {
                            ships[s]["detailedItems"] = {};
                            raw.forEach(function (item) {
                                var twig = item.split("=");
                                if (twig.length === 2) {
                                    // Remove format whitespacing.
                                    twig[0] = twig[0].trim();
                                    twig[1] = twig[1].trim();
                                    ships[s]["detailedItems"][twig[0]] = twig[1];
                                }
                            });
                        }
                    }
                }
            });

            // Separate ajax calls for images.
            localStorage.setItem('fullDataAmount', (parseInt(localStorage.getItem('fullDataAmount')) + 1) + "");
            $.ajax({
                url: "https://azurlane.koumakan.jp/w/api.php",
                method: "GET",
                dataType: "jsonp",
                data: {
                    action: "query",
                    list: "allimages",
                    ailimit: 300,
                    aifrom: shipNameTag,
                    aiprop: "url",
                    format: "json"
                },
                success: function (data2) {
                    localStorage.setItem('dataFetched', (parseInt(localStorage.getItem('dataFetched')) + 1) + "");
                    var allImages = data2["query"]["allimages"];
                    allImages.forEach(function (item) {
                        resource_db[item["name"]] = item["url"];
                    });
                }
            });
        }

        // Essentially, waits until the ajaxes (above) are done, and then saves the data.
        var interval = window.setInterval(function () {
            $("#loading_pleaseWait_percentage").text(Math.round((parseInt(localStorage.getItem('dataFetched')) / parseFloat(localStorage.getItem('fullDataAmount'))) * 100) + "% done");
            if (localStorage.getItem('dataFetched') === localStorage.getItem('fullDataAmount')) {

                localStorage.removeItem('dataFetched');
                localStorage.removeItem('fullDataAmount');

                // All data received, now parse and render.
                document.title = "AzurViewer";
                $("#loading_pleaseWait").hide();
                $("#omnisearch").show();
                showMainMenu();
                ship_db = ships;

                // Attempt to cache data locally (reduces load times after initial loading)
                localforage.setItem('az_ship', JSON.stringify(ship_db), function (error) {
                    if (error !== null) {
                        alert("Error while attempting to cache ship data.");
                    }
                });
                localforage.setItem('az_resource', JSON.stringify(resource_db), function (error) {
                    if (error !== null) {
                        alert("Error while attempting to cache resource data.");
                    }
                });

                clearInterval(interval);
            }
            else if ((document.readyState === "complete") && (localStorage.getItem('dataFetched') !== localStorage.getItem('fullDataAmount'))) {
                // reload the app as some data failed to load correctly.
                location.reload();
            }
        }, 500);
    }

    // Starting method of application (w/o cache). Starts by fetching a list of ships.
    function start() {
        $.ajax({
            url: "https://azurlane.koumakan.jp/w/api.php",
            method: "GET",
            dataType: "jsonp",
            data: {
                action: "parse",
                page: "List_of_Ships",
                format: "json"
            },
            success: function (data) {
                // text variable contains a fragment of HTML.
                var text = data['parse']['text']['*'];
                text = text.split("<");
                $('#loading_pleaseWait').show();
                parseListOfShips(text);
            }
        });
    }

    // Starting point w. cache. Load cache and start application. Typically this is where the application is expected to start from...
    localforage.getItem('az_ship', function (error, value) {
        if (error !== null) {
            alert("Error while attempting to load cached ship data.");
            start();
        }
        else if (value === null) {
            // No data exists!
            start();
        }
        else {
            localforage.getItem('az_resource', function (error2, value2) {
                if (error2 !== null) {
                    alert("Error while attempting to load cached resource data.");
                    start();
                }
                else if (value2 === null) {
                    start();
                }
                else {
                    ship_db = JSON.parse(value);
                    resource_db = JSON.parse(value2);

                    // Cache should be loaded.
                    document.title = "AzurViewer";
                    $("#loading_pleaseWait").hide();
                    $("#omnisearch").show();
                    showMainMenu();
                }
            });
        }
    });

    // Makes the search results appear and disappear as search is focused.
    window.setInterval(function () {
        
        if (!$('#ship_displayCase').is(':visible')){
            $('#mainMenuDisplay').show(); //don't call showMainMenu as it will infinitely concat more rows.
        }
        else{
            $('#mainMenuDisplay').hide();
        }
            
        var search = $("#search");
        if (search.is(":focus") && (search.val().length > 0)) {
            $("#search_results").show();
            $("#ship_displayCase").hide();
            $('#mainMenuDisplay').hide();
            document.title = "AzurViewer";
            devClicks = 0;
            $("#ship_displayCase_rawData").text("");
        }
        else {
            $("#search_results").hide();
        }
    }, 500);

    // Search functionality (WIP)
    window.setInterval(function () {

        var omnisearch = $("#search").val();
        var searchResult = $('#search_results');

        if (omnisearch !== searchTextCache) {
            searchTextCache = omnisearch;
            // clear current results
            var node = document.getElementById("search_results");
            while (node.firstChild) {
                node.removeChild(node.firstChild);
            }

            // Get the object keys from ship object (searching indexes).
            var searchKeywords = Object.keys(ship_db['Ayanami']);
            // Remove detailed items array key.
            var index = searchKeywords.indexOf('detailedItems');
            if (index !== -1) searchKeywords.splice(index, 1);
            // Combine detailedItems keys as well.
            searchKeywords = searchKeywords.concat(Object.keys(ship_db['Ayanami']['detailedItems']));
            var searchByKeyword = '', keywordDetected = false;
            searchKeywords.forEach(function (item) {
                if (omnisearch.indexOf(item + ":") === 0) {
                    // A search keyword is detected.
                    searchByKeyword = item;
                    keywordDetected = true;
                }
            });

            if (omnisearch.length > 0) {
                if (keywordDetected) {
                    // Special keyword search. seasrchByKeyword should be defined as an object key.
                    // Attempt to detect if the property is from 'detailedItems'

                    // First, though, notify the user that we are searching by special keyword.
                    var searchTarget = omnisearch.substring(searchByKeyword.length + 1).trim();
                    var notify = $('<li></li>');
                    notify.addClass('collection-item');
                    notify.html('<b>Searching by ' + searchByKeyword + ' ... (' + searchTarget + ')</b>');
                    searchResult.append(notify);
                    var addition = $('<li></li>');
                    addition.addClass('collection-item');
                    addition.html('<i>For a full list of searchable components, click <a onclick="$(\'#search\').val(\'allsearchablecomponents\');" style="cursor:pointer;">here</a>.</i>');
                    searchResult.append(addition);
                    if (searchByKeyword[0] === searchByKeyword[0].toUpperCase()) {
                        // first letter is uppercase, search inside detailedItems.
                        var shipNames = Object.keys(ship_db);
                        shipNames.forEach(function (name) {
                            if (ship_db[name]['detailedItems'][searchByKeyword].toLowerCase().indexOf(searchTarget.toLowerCase()) !== -1) {
                                var newListElement = $('<li></li>');
                                newListElement.addClass('collection-item');
                                newListElement.click(function () {
                                    renderShipDisplayCase(name);
                                });
                                newListElement.html('<a onclick="renderShipDisplayCase(\'' + name + '\')" style=\'color: black; text-decoration: none; cursor: pointer;\'>' + name + '</a>');
                                searchResult.append(newListElement);
                            }
                        });
                    }
                    else {
                        // same type of search, but perform outside detailedItems.
                        var shipNames = Object.keys(ship_db);
                        shipNames.forEach(function (name) {
                            if (ship_db[name][searchByKeyword].toLowerCase().indexOf(searchTarget.toLowerCase()) !== -1) {
                                var newListElement = $('<li></li>');
                                newListElement.addClass('collection-item');
                                newListElement.click(function () {
                                    renderShipDisplayCase(name);
                                });
                                newListElement.html('<a onclick="renderShipDisplayCase(\'' + name + '\')" style=\'color: black; text-decoration: none; cursor: pointer;\'>' + name + '</a>');
                                searchResult.append(newListElement);
                            }
                        });
                    }
                }
                else if (omnisearch.toLowerCase() === "help") {
                    var helpData = {
                        "regular search": "Enter text and search results will appear based on ship name.",
                        "compare": "Compares named ships' stats. <a onclick='$(\"#search\").val(\"compare prinz eugen, belfast, universal bullin\");' style='cursor: pointer;'>Click for an example</a>",
                        "allsearchablecomponents (or asc)": "Gives a list of searchable keywords, with examples built in.",
                        "help": "Shows all possible commands."
                    };
                    for (var name in helpData) {
                        var newListElement = $("<li></li>");
                        newListElement.addClass('collection-item');
                        newListElement.html(name + " : " + helpData[name]);
                        searchResult.append(newListElement);
                    }
                }
                else if ((omnisearch.toLowerCase() === 'allsearchablecomponents') || (omnisearch.toLowerCase() === 'asc')) {
                    var allComps = $('<li></li>');
                    allComps.addClass('collection-item');
                    allComps.html('<b>Search format is [component]: search. All searchable components: </b>');
                    searchResult.append(allComps);
                    searchKeywords.forEach(function (item) {
                        var c = $('<li></li>');
                        c.addClass('collection-item');
                        c.html('<i><a onclick="$(\'#search\').val(\'' + item + ': \');" style="cursor:pointer;">' + item + '</a></i>');
                        searchResult.append(c);
                    });
                }
                else if (omnisearch.toLowerCase().indexOf('compare') !== -1) {
                    var newListElement = $('<li></li>');
                    newListElement.addClass('collection-item');
                    newListElement.html("<b>Compare functionality currently not added. Please check back later.</b> ( O w O ) /");
                    searchResult.append(newListElement);
                }
                else {
                    var shipNames = Object.keys(ship_db);
                    shipNames.forEach(function (item) {
                        if (item.toLowerCase().indexOf(omnisearch.toLowerCase()) !== -1) {
                            // add to search_results
                            var newListElement = $('<li></li>');
                            newListElement.click(function () {
                                renderShipDisplayCase(item);
                            });
                            newListElement.css('cursor', 'pointer');
                            newListElement.addClass('collection-item');
                            newListElement.html("<a onclick='renderShipDisplayCase(\"" + item + "\")' style='color: black; text-decoration: none; cursor: pointer;'>" + item + "</a>");
                            searchResult.append(newListElement);
                        }
                    });
                }
            }
        }

    }, 500);

    // Prevent submitting and reloading the page (by pressing enter) with omnisearch.
    $('#search').keypress(function (event) {
        if (event.keyCode === 10 || event.keyCode === 13) {
            event.preventDefault();
        }
    });

    $('#skinModal').modal();
    $('#miscInfoModal').modal();

    $(document).ready(function () {
        $('.collapsible').collapsible();
    });

</script>
</body>
</html>
