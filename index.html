<!DOCTYPE html>

<!-- 
AzurViewer
[ A web explorer for Azur Lane. Look at detailed ship stats, descriptions and more. ]
-------
What is the license?
Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0), as stated with Wikimedia-related content unless stated otherwise.
See link for more details: https://creativecommons.org/licenses/by-nc-sa/4.0/
How does it work?
Essentially, the app scrapes data from the wiki and parses it correctly into an app. This removes the need to rewrite tons and tons of 
existing information. (phew). Of course, too many requests will flood the wiki, so data is attempted caching into localStorage.
Developed by Chen Zheng (@HotFireyDeath)
-->

<html>
    <head>
        <title>AzurViewer</title>
      
        <!-- GOOGLE FONTS -->
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
      
        <!-- JQUERY -->
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
      
        <!-- MATERIALIZE -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
      
        <style> body { font-family: "Open Sans", Serif; } </style>
    </head>
    <body>
      
        <div id="loading_pleaseWait">
          <div class="container">
            <div class="card horizontal">
              <div class="card-image">
                <img id="loading_pleaseWait_char" src="https://azurlane.koumakan.jp/w/images/f/fb/SaratogaChibi.png">
              </div>
              <div class="card-stacked">
                <div class="card-content" style="text-align: center;" id="loading_pleaseWait_phrase">
                  Commander, please wait a moment~
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <script>
          
            // Set random loading character and 'slogan'.
            var loadingRandoms = {
              "https://azurlane.koumakan.jp/w/images/8/86/LaffeyChibi.png" : "Commander... wait here (yawn)...",
              "https://azurlane.koumakan.jp/w/images/f/fb/SaratogaChibi.png" : "Commander, please wait a moment~",
              "https://azurlane.koumakan.jp/w/images/0/08/AyanamiChibi.png" : "Please wait a second, commander...",
              "https://azurlane.koumakan.jp/w/images/8/84/BelfastChibi.png" : "Pardon me, Commander, but you will have to wait a second. Meanwhile, would you like some tea?"
            };
            // This is a slightly modified version of the solution found here: https://stackoverflow.com/a/15106541
            var randomKey = function (loadingRandoms){
              var keys = Object.keys(loadingRandoms);
              return keys[keys.length * Math.random() << 0];
            };
            var randomKey = randomKey(loadingRandoms)
            $("#loading_pleaseWait_char").attr("src", randomKey);
            $("#loading_pleaseWait_phrase").text(loadingRandoms[randomKey]);
          
          
            // An object containing the URL to useful icons.
            var icons = {
                "firepower": "https://azurlane.koumakan.jp/w/images/thumb/d/d5/Firepower.png/25px-Firepower.png",
                "health": "https://azurlane.koumakan.jp/w/images/thumb/8/8b/Duration.png/25px-Duration.png",
                "anti_air": "https://azurlane.koumakan.jp/w/images/thumb/0/0f/AntiAir.png/25px-AntiAir.png",
                "evasion": "https://azurlane.koumakan.jp/w/images/thumb/d/d2/Evasion.png/25px-Evasion.png",
                "air_power": "https://azurlane.koumakan.jp/w/images/thumb/6/6a/Aviation.png/25px-Aviation.png",
                "aviation": "https://azurlane.koumakan.jp/w/images/thumb/6/6a/Aviation.png/25px-Aviation.png",
                "torpedo": "https://azurlane.koumakan.jp/w/images/thumb/4/40/Torpedo.png/25px-Torpedo.png"
            };
          
            // An object containing ALL ship data. This is a large variable.
            var ship_db = {};
          
            /**
             Gets the index of the nth occurance of a substring in a string.
             This solution was deprived from StackOverflow, original answer found here:
             https://stackoverflow.com/a/14482123
             */
            function nthIndex(str, pat, n) {
                var L = str.length, i = -1;
                while (n-- && i++ < L) {
                    i = str.indexOf(pat, i);
                    if (i < 0) break;
                }
                return i;
            }
          
            /**
             Parses the list of ships given the wikimedia HTML parse data for https://azurlane.koumakan.jp/List_of_Ships.
             This is hard-coded, and therefore is subject to breaking. Will attempt to update as often as possible.
             Developed by @HotFireyDeath (Chen Zheng)
             https://czheng.me
             */
            function parseListOfShips(data) {
                var ships = {};
                // Parse ship's 'top layer' data using List of Ships Azur Wiki result.
                for (var i = 0; i < data.length; i++) {
                    if ((i + 1) < data.length) { // Check for out of bounds.
                        if (
                            data[i].includes("td data-sort-value=") &&
                            data[i + 1].includes("a href=\"") &&
                            (isNaN(data[i + 1].substring(data[i + 1].indexOf(">") + 1)) || (parseInt(data[i + 1].substring(data[i + 1].indexOf(">") + 1)) < 3000))
                        ) {
                            var shipName = (data[i + 1].substring(9, nthIndex(data[i + 1], "\"", 2))).replace(/_/g, " ");
                            ships[shipName] = {
                                pageLink: "/" + shipName.replace(/ /g, "_"), // Ship Wikimedia page
                                id: data[i + 1].substring(data[i + 1].indexOf(">") + 1), // Ship ID
                                category: data[i + 11].substring(data[i + 11].indexOf(">") + 1),
                                rarity: data[i + 8].substring(data[i + 8].indexOf(">") + 1),
                                affiliation: data[i + 15].substring(data[i + 15].indexOf(">") + 1),
                                firepower_rating: data[i + 18].substring(data[i + 18].indexOf(">") + 1),
                                health_rating: data[i + 20].substring(data[i + 20].indexOf(">") + 1),
                                anti_air_rating: data[i + 22].substring(data[i + 22].indexOf(">") + 1),
                                evasion_rating: data[i + 24].substring(data[i + 24].indexOf(">") + 1),
                                air_power_rating: data[i + 26].substring(data[i + 26].indexOf(">") + 1),
                                torpedo_rating: data[i + 28].substring(data[i + 28].indexOf(">") + 1)
                            }
                        }
                    }
                }
                document.title = "0";
                // Deep search for each ship, grab available stats.
                for (var name in ships) {
                    //var name = "Universal Bullin";
                    var shipNameTag = ships[name]["pageLink"].substring(1);
                    document.title = (parseInt(document.title) + 1) + "";
                    $.ajax({
                        url: "https://azurlane.koumakan.jp/w/api.php",
                        method: "GET",
                        dataType: "jsonp",
                        data: {
                            action: "parse",
                            page: shipNameTag,
                            prop: "wikitext",
                            format: "json"
                        },
                        success: function (data) {
                            document.title = (parseInt(document.title) - 1) + "";
                            var raw = data["parse"]["wikitext"]["*"];
                            raw = raw.split("|");
                          
                            // Reverse search ships by matching ID.
                            var currentShipID = raw[1].split("=")[1].trim();
                            for (var s in ships){
                              if (ships[s]["id"] === currentShipID){
                                ships[s]["detailedItems"] = {};
                                raw.forEach(function(item){
                                  var twig = item.split("=");
                                  if (twig.length === 2){
                                    // Remove format whitespacing.
                                    twig[0] = twig[0].trim();
                                    twig[1] = twig[1].trim();
                                    ships[s]["detailedItems"][twig[0]] = twig[1];
                                  }
                                });
                              }
                            }
                        }
                    });
                }
              
                // Essentially, waits until the ajaxes (above) are done, and then saves the data.
                var interval = window.setInterval(function(){
                    if (document.title === "0"){
                        document.title = "AzurViewer";
                        $("#loading_pleaseWait").hide();
                        ship_db = ships;
                        clearInterval(interval);
                    }
                }, 1000);
            }
          
            
            $.ajax({
                url: "https://azurlane.koumakan.jp/w/api.php",
                method: "GET",
                dataType: "jsonp",
                data: {
                    action: "parse",
                    page: "List_of_Ships",
                    format: "json"
                },
                success: function (data) {
                    // text variable contains a fragment of HTML.
                    var text = data['parse']['text']['*'];
                    text = text.split("<");
                  
                    var parsedShips = parseListOfShips(text);
                }
            });
          
        </script>
    </body>
</html>
